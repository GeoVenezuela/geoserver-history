<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
  <!-- Automatic getCapabilities Configuration -->
  <bean id="gwcGSConfig" class="org.geowebcache.util.GeoServerConfiguration">
    <constructor-arg type="org.geowebcache.cache.CacheFactory" ref="gwcCacheFactory"/>
    <constructor-arg value="image/png,image/png8,image/jpeg,image/gif,application/vnd.google-earth.kml+xml"/>
    <constructor-arg value="4x4"/>
    <constructor-arg value="format_options=regionateby:auto"/>
  </bean>

  <!-- Auxilliary XML Configuration, place geowebcache.xml in $GEOSERVER_DATA_DIR/gwc or WEB-INF/classes to activate -->
  <bean id="gwcXmlConfig" class="org.geowebcache.util.XMLConfiguration">
    <constructor-arg type="org.geowebcache.cache.CacheFactory" ref="gwcCacheFactory" />
    <!-- used to find $GEOSERVER_DATA_DIR or GEOWEBCACHE_CACHE_DIR -->
    <property name="fileCache" ref="gwcCacheFile" />
  </bean>

  <!-- controller for handling all incoming requests -->
  <bean id="gwcDispatcher" class="org.geowebcache.GeoWebCacheDispatcher">
    <property name="tileLayerDispatcher" ref="gwcTLDispatcher"/>
    <property name="servletPrefix" value="gwc"/>
  </bean>

  <!-- Tile layer dispatcher -->
  <bean id="gwcTLDispatcher" class="org.geowebcache.layer.TileLayerDispatcher">
    <property name="config">
      <list>
	<ref bean="gwcGSConfig"/>
	<ref bean="gwcXmlConfig"/>
      </list>
    </property>
  </bean>
    
  <!-- Stuff for the REST dispatcher -->
  <!-- bean id="gwcXmlConfig" class="org.geowebcache.util.XMLConfiguration" / -->

  <!-- Services -->
  <bean id="gwcServiceWMS" class="org.geowebcache.service.wms.WMSService">
    <property name="config"><list><ref bean="gwcGSConfig"/></list></property>
    <property name="proxyRequests"><value>TRUE</value></property>
  </bean>
  <bean id="gwcServiceGMaps"
	class="org.geowebcache.service.gmaps.GMapsConverter"/>
  <bean id="gwcServiceMGMaps"
	class="org.geowebcache.service.mgmaps.MGMapsConverter"/>
  <bean id="gwcServiceVE"
	class="org.geowebcache.service.ve.VEConverter"/>
  <bean id="gwcServiceKML"
	class="org.geowebcache.service.kml.KMLService"/>
  
  <!-- Thread pool for seeding -->
  <bean id="gwcSeederThreadPoolExec" 
    class="org.geowebcache.rest.seed.SeederThreadPoolExecutor">
    <constructor-arg value="16"/><!-- Size of core pool -->
    <constructor-arg value="32"/><!-- Maximum size of pool -->
  </bean>

  <!-- Restlets -->
  <bean id="gwcSeedRestlet" class="org.geowebcache.rest.seed.SeedRestlet">
    <property name="tileLayerDispatcher" ref="gwcTLDispatcher"/>
    <property name="threadPoolExecutor" ref="gwcSeederThreadPoolExec"/>
  </bean>  
  <bean id="gwcSeedFormRestlet" class="org.geowebcache.rest.seed.SeedFormRestlet">
    <property name="tileLayerDispatcher" ref="gwcTLDispatcher"/>
    <property name="threadPoolExecutor" ref="gwcSeederThreadPoolExec"/>
  </bean>
  <bean id="gwcReloadRestlet" class="org.geowebcache.rest.reload.ReloadRestlet">
    <property name="tileLayerDispatcher" ref="gwcTLDispatcher"/>
  </bean>
  <bean id="gwcTileLayerRestlet" class="org.geowebcache.rest.layers.TileLayerRestlet">
    <property name="XMLConfiguration" ref="gwcXmlConfig"/>
    <property name="tileLayerDispatcher" ref="gwcTLDispatcher"/>
  </bean>
  
  <!-- REST Dispatcher -->
  <bean id="gwcRestDispatcher" class="org.geowebcache.rest.RESTDispatcher">
    <constructor-arg type="java.util.Map">
      <map>
        <entry>
          <key><value>/rest/seed/{layer}.{extension}</value></key>
          <ref bean="gwcSeedRestlet" />
        </entry>
        <entry>
          <key><value>/rest/seed/{layer}</value></key>
          <ref bean="gwcSeedFormRestlet" />
        </entry>
        <entry>
          <key><value>/rest/reload</value></key>
          <ref bean="gwcReloadRestlet" />
        </entry>
        <entry>
          <key><value>/rest/layers/{layer}.{extension}</value></key>
          <ref bean="gwcTileLayerRestlet" />
        </entry>
      </map>
    </constructor-arg>
  </bean>

  <bean id="gwcUrlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
    <property name="alwaysUseFullPath" value="true"/>
    <property name="mappings">
      <props>
        <prop key="/gwc/**">gwcDispatcher</prop>
        <prop key="/gwc">gwcDispatcher</prop>
	    <prop key="/gwc/rest/**">gwcRestDispatcher</prop>
	    <!-- prop key="/proxy/**">gwcProxyDispatcher</prop -->
      </props>
    </property>
  </bean>

  <!-- Cache backends -->
  <bean id="gwcCacheFile" class="org.geowebcache.cache.file.FileCache">
    <property name="defaultKeyBeanId"><value>gwcCacheKeyFile</value></property>
  </bean>
  <bean id="gwcCacheKeyFile" class="org.geowebcache.cache.file.FilePathKey2"/>
  
  <!-- Cache and CacheKey factories -->
  <bean id="gwcCacheKeyFactory" class="org.geowebcache.cache.CacheKeyFactory"/>

  <bean id="gwcCacheFactory" class="org.geowebcache.cache.CacheFactory">
    <constructor-arg type="org.geowebcache.cache.CacheKeyFactory" ref="gwcCacheKeyFactory"/>
    <property name="defaultCacheBeanId"><value>gwcCacheFile</value></property>
  </bean>
</beans>
